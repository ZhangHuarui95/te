name: 代码质量与安全检查（串行执行）

# 触发条件：PR 提交到 main 分支或手动触发
on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # 允许手动触发

jobs:
  # 第一个 job：代码质量检查（先执行）
  code-quality:
    name: 代码质量检查
    runs-on: ubuntu-latest
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pytest
          pip install -r requirements.txt

      - name: 代码风格检查（flake8）
        run: flake8 src/ --max-line-length=120 --statistics

      - name: 单元测试（pytest）
        run: pytest tests/ --cov=src/ --cov-report=term

  # 第二个 job：安全扫描（依赖第一个 job 完成后才执行）
  security-scan:
    name: 安全扫描
    needs: code-quality  # 关键配置：等待 code-quality 完成后才执行
    runs-on: ubuntu-latest
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: 安装安全扫描工具
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit

      - name: 依赖安全检查（safety）
        run: safety check --full-report

      - name: 代码安全扫描（bandit）
        run: bandit -r src/ -f json -o bandit-report.json

      - name: 上传安全扫描报告
        uses: actions/upload-artifact@v3
        with:
          name: bandit-report
          path: bandit-report.json
